<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Defcon - User manual</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="01-introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="02-getting-started.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="03-configuration.html"><strong aria-hidden="true">3.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="04-runner.html"><strong aria-hidden="true">4.</strong> Off-site runner</a></li><li class="chapter-item expanded "><a href="05-checks.html"><strong aria-hidden="true">5.</strong> Checks</a></li><li class="chapter-item expanded "><a href="06-groups.html"><strong aria-hidden="true">6.</strong> Groups</a></li><li class="chapter-item expanded "><a href="07-handlers.html"><strong aria-hidden="true">7.</strong> Handlers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="07-handlers/ping.html"><strong aria-hidden="true">7.1.</strong> Ping</a></li><li class="chapter-item expanded "><a href="07-handlers/tcp.html"><strong aria-hidden="true">7.2.</strong> TCP connection</a></li><li class="chapter-item expanded "><a href="07-handlers/udp.html"><strong aria-hidden="true">7.3.</strong> UDP datagram</a></li><li class="chapter-item expanded "><a href="07-handlers/http.html"><strong aria-hidden="true">7.4.</strong> HTTP request</a></li><li class="chapter-item expanded "><a href="07-handlers/dns.html"><strong aria-hidden="true">7.5.</strong> DNS</a></li><li class="chapter-item expanded "><a href="07-handlers/whois.html"><strong aria-hidden="true">7.6.</strong> Domain expiration</a></li><li class="chapter-item expanded "><a href="07-handlers/tls.html"><strong aria-hidden="true">7.7.</strong> TLS expiration</a></li><li class="chapter-item expanded "><a href="07-handlers/appstores.html"><strong aria-hidden="true">7.8.</strong> App stores</a></li><li class="chapter-item expanded "><a href="07-handlers/deadmanswitch.html"><strong aria-hidden="true">7.9.</strong> Dead Man Switch</a></li></ol></li><li class="chapter-item expanded "><a href="08-alerters.html"><strong aria-hidden="true">8.</strong> Alerters</a></li><li class="chapter-item expanded "><a href="api.html"><strong aria-hidden="true">9.</strong> REST API</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Defcon - User manual</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#defcon" id="defcon">Defcon</a></h1>
<p>Defcon is a tool for monitoring external services for specific failure scenarii. You can see it as a lightweight Nagios focused on watching over networked services. This kind of tool is sometimes calls <em>uptime monitoring services</em>.</p>
<p>A common example use case of what you can do with Defcon is periodically perform an HTTP request to an API endpoint and verify that the response status code is <code>200 OK</code> and the content contains the words <code>ready</code>, sending a message on a Slack channel whenever the check fails three times in a row.</p>
<blockquote>
<p>This documentation is still in the process of being written, it is far from complete and could not bring you all the information you need.</p>
</blockquote>
<h2><a class="header" href="#concepts" id="concepts">Concepts</a></h2>
<h3><a class="header" href="#checks" id="checks">Checks</a></h3>
<p>The main concept in Defcon is that of a <strong>check</strong>. A check is a definition for an external service, including how to monitor it, how to detect issues, when to consider it as failing and what do do when it is.</p>
<p>Each check includes what is called a <strong>handler specification</strong> (or <code>spec</code>), that describes how this service is to be monitored. This specification must be one of the supported handlers, as described in this section.</p>
<h3><a class="header" href="#alerters" id="alerters">Alerters</a></h3>
<p>Each check can optionally trigger an alert when an outage is confirmed by its handler. All alerters in Defcon use <code>webhooks</code> to transmit information about the failing check to a HTTP server (outside Defcon's scope) that will handle the actual notification handling.</p>
<h3><a class="header" href="#site" id="site">Site</a></h3>
<p>A site is a distinct location (read, <em>server</em>), where checks can be run from. This allows for monitoring services from different locations concurrently to help avoid detection issues caused by hardware failing, network partitions or transient problems.</p>
<p>Each check can be set to run on one of more different sites, with a configurable number of failing sites needed for an outage to be confirmed.</p>
<h1><a class="header" href="#getting-started" id="getting-started">Getting started</a></h1>
<p>This guide will help you set up a simple Defcon instance, configure a first HTTP check and query the results through the bundled API.</p>
<h2><a class="header" href="#requirements" id="requirements">Requirements</a></h2>
<p>The following list described the infrastructure required to follow this guide:</p>
<ul>
<li>A Linux box</li>
<li>A MySQL instance, with a user account and an empty database</li>
</ul>
<h2><a class="header" href="#download-a-release" id="download-a-release">Download a release</a></h2>
<p>Binaries are listed under the <a href="https://github.com/apognu/defcon/release">Releases</a> section of the GitHub repository. A new release will be created for each tag on the codebase, and a special <code>tip</code> release follow <code>master</code> and provides the latest snapshot of the code.</p>
<pre><code class="language-shell">$ curl https://github.com/apognu/defcon/releases/download/tip/defcon-tip-x86_64 &gt; defcon
$ chmod +x defcon
</code></pre>
<h2><a class="header" href="#running-the-controller" id="running-the-controller">Running the controller</a></h2>
<p>From here, you can start the controller:</p>
<pre><code class="language-shell">$ RUST_LOG=defcon=debug \
  DSN=mysql://defcon:password@mysql.host/defcon?ssl-mode=DISABLED \
  ./defcon
INFO[2021-02-06T11:48:51.801+0000] starting api process port=&quot;8000&quot;
INFO[2021-02-06T11:48:51.801+0000] starting handler process interval=&quot;1s&quot;
INFO[2021-02-06T11:48:51.801+0000] no public key found, disabling runner endpoints
</code></pre>
<h2><a class="header" href="#creating-your-first-check" id="creating-your-first-check">Creating your first check</a></h2>
<p>In this guide, we will monitor two HTTP services, that will need to return a <code>200 OK</code> status code to pass. Each check will run every 10 seconds and will require three failures to be considered failed. We will use the Defcon API to create the checks.</p>
<p>Our first check can be represented with the following JSON:</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;Successful HTTP request&quot;,
  &quot;interval&quot;: &quot;10s&quot;,
  &quot;sites&quot;: [&quot;@controller&quot;],
  &quot;passing_threshold&quot;: 3,
  &quot;failing_threshold&quot;: 3,
  &quot;site_threshold&quot;: 1,
  &quot;spec&quot;: {
    &quot;kind&quot;: &quot;http&quot;,
    &quot;url&quot;: &quot;http://jsonplaceholder.typicode.com/users&quot;,
    &quot;code&quot;: 200
  }
}
</code></pre>
<p>This snippet defines the following:</p>
<ul>
<li>The human-readable name for this check</li>
<li>The interval at which the check should be run (here, 10 seconds)</li>
<li>The sites on which the check will be run (<code>@controller</code> is the implicit name for Defcon's controller)</li>
<li>Each site will be considered as failed when the checks fails three times in a row, and recovered after three successes</li>
<li>An outage will be created when the number of failed sites reaches 1</li>
<li>This check uses the <code>http</code> handler, making a <code>GET</code> request to the provided URL, and expect a response status code of <code>200</code></li>
</ul>
<p>You can create the check by performing a <code>POST</code> request to <code>http://127.0.0.1:8000/api/checks</code>:</p>
<pre><code class="language-shell">$ curl -v -XPOST http://127.0.0.1:8000/api/checks -d@book.json
HTTP/1.1 201 Created
location: /api/checks/82a3b532-0883-4544-ba2c-0a7159a89d8e
</code></pre>
<p>You can check the configuration for this check by calling the API with the returned path:</p>
<pre><code class="language-shell">$ curl http://127.0.0.1:8000/api/checks/82a3b532-0883-4544-ba2c-0a7159a89d8e
{
    &quot;alerter&quot;: null,
    &quot;enabled&quot;: true,
    &quot;failing_threshold&quot;: 3,
    &quot;interval&quot;: &quot;10s&quot;,
    &quot;name&quot;: &quot;Successful HTTP request&quot;,
    &quot;passing_threshold&quot;: 3,
    &quot;silent&quot;: false,
    &quot;site_threshold&quot;: 0,
    &quot;sites&quot;: [
        &quot;@controller&quot;
    ],
    &quot;spec&quot;: {
        &quot;code&quot;: 200,
        &quot;content&quot;: null,
        &quot;digest&quot;: null,
        &quot;headers&quot;: {},
        &quot;kind&quot;: &quot;http&quot;,
        &quot;timeout&quot;: null,
        &quot;url&quot;: &quot;http://jsonplaceholder.typicode.com/users&quot;
    },
    &quot;uuid&quot;: &quot;82a3b532-0883-4544-ba2c-0a7159a89d8e&quot;
}
</code></pre>
<h2><a class="header" href="#check-the-check-status" id="check-the-check-status">Check the check status</a></h2>
<p>If you look at your console where Defcon is running, you should see that the handler for this check is running:</p>
<pre><code class="language-shell">DEBG[2021-02-05T20:30:44.323+0000] check passed site=&quot;@controller&quot; kind=&quot;http&quot; check=&quot;82a3b532-0883-4544-ba2c-0a7159a89d8e&quot; name=&quot;Successful HTTP request&quot;
DEBG[2021-02-05T20:30:54.203+0000] check passed site=&quot;@controller&quot; kind=&quot;http&quot; check=&quot;f00ee7ad-b389-4819-bb24-e9797735e2df&quot; name=&quot;Successful HTTP request&quot;
DEBG[2021-02-05T20:30:54.207+0000] check passed site=&quot;@controller&quot; kind=&quot;http&quot; check=&quot;cf4a4917-92fb-4721-ab76-cae6a5fda2b8&quot; name=&quot;Successful HTTP request&quot;
</code></pre>
<h2><a class="header" href="#create-a-failing-check" id="create-a-failing-check">Create a failing check</a></h2>
<p>As an exercice to the reader, create another check from the above model, but this time, define it as expecting a <code>201</code> status code. This check should fail and create an outage when <code>failing_threshold</code> is reached.</p>
<pre><code class="language-shell">DEBG[2021-02-05T20:56:42.185+0000] check failed site=&quot;@controller&quot; kind=&quot;http&quot; check=&quot;4766d0dc-5d39-4ec7-8aee-95b46f33dc55&quot; name=&quot;Personal - Website &amp; API&quot; message=&quot;status code was 200&quot;
DEBG[2021-02-05T20:56:53.164+0000] check failed site=&quot;@controller&quot; kind=&quot;http&quot; check=&quot;4766d0dc-5d39-4ec7-8aee-95b46f33dc55&quot; name=&quot;Personal - Website &amp; API&quot; message=&quot;status code was 200&quot;
DEBG[2021-02-05T20:57:04.192+0000] check failed site=&quot;@controller&quot; kind=&quot;http&quot; check=&quot;4766d0dc-5d39-4ec7-8aee-95b46f33dc55&quot; name=&quot;Personal - Website &amp; API&quot; message=&quot;status code was 200&quot;
INFO[2021-02-05T20:57:04.291+0000] site outage started site=&quot;@controller&quot; kind=&quot;http&quot; check=&quot;4766d0dc-5d39-4ec7-8aee-95b46f33dc55&quot; failed=&quot;3/3&quot; passed=&quot;0/3&quot;
INFO[2021-02-05T20:57:04.358+0000] outage confirmed check=&quot;4766d0dc-5d39-4ec7-8aee-95b46f33dc55&quot; outage=&quot;f3bdec24-1f7f-4fd6-bbe8-2e937cc67746&quot; since=&quot;2021-02-05 20:57:04 UTC&quot;
</code></pre>
<p>Here you can see that a site outage was created, and since our <code>site_threshold</code> was set to <code>1</code>, an outage was confirmed for the check.</p>
<h1><a class="header" href="#configuration" id="configuration">Configuration</a></h1>
<p>The controller has a few configuration knobs you can tweak to adjust its overall behavior, they are described in this document. Most of them are optional and default to maybe-no-so sensible values. All configuration is applied through environment variables.</p>
<h2><a class="header" href="#handler-configuration" id="handler-configuration">Handler configuration</a></h2>
<table><thead><tr><th>Environment variable</th><th>Required</th><th>Default value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>RUST_LOG</code></td><td></td><td>defcon=info</td><td></td></tr>
<tr><td><code>DSN</code></td><td>Yes</td><td></td><td>Connection string to the MySQL database</td></tr>
<tr><td><code>PUBLIC_KEY</code></td><td>Yes</td><td></td><td>Path to an PEM-encoded ECDSA public key</td></tr>
<tr><td><code>API_ENABLE</code></td><td></td><td>1</td><td>Enable or disable the API process</td></tr>
<tr><td><code>API_LISTEN</code></td><td></td><td>127.0.0.1:8000</td><td>Set the listen address and port of the API process</td></tr>
<tr><td><code>HANDLER_ENABLE</code></td><td></td><td>1</td><td>Enable or disable the handler process</td></tr>
<tr><td><code>HANDLER_INTERVAL</code></td><td></td><td>1s</td><td>Interval between handler loop iterations</td></tr>
<tr><td><code>HANDLER_SPREAD</code></td><td></td><td>0s</td><td>Maximum random delay applied when a check needs to run</td></tr>
<tr><td><code>CLEANER_ENABLE</code></td><td></td><td>0</td><td>Enable or disable the cleaner process</td></tr>
<tr><td><code>CLEANER_INTERVAL</code></td><td></td><td>10m</td><td>Interval between cleaner loop iterations</td></tr>
<tr><td><code>CLEANER_THRESHOLD</code></td><td></td><td>1y</td><td>Period of time after which to delete stale objects</td></tr>
</tbody></table>
<h3><a class="header" href="#rust_log" id="rust_log"><code>RUST_LOG</code></a></h3>
<p>This allows for controlling the log level for each individual dependency. Defcon uses the <code>defcon</code> identifier, and default to <code>info</code>, which will mainly print errors, API access logs and when outages are created and resolved.</p>
<h3><a class="header" href="#dsn" id="dsn"><code>DSN</code></a></h3>
<p>This should be a full connection string (with options) to the database Defcon is to use, and start with <code>mysql://</code>, as this is the only database supported by Defcon. This is an example of a valid <code>DSN</code>.</p>
<pre><code>mysql://user:password@host:3306/defcon
</code></pre>
<h3><a class="header" href="#public_key" id="public_key"><code>PUBLIC_KEY</code></a></h3>
<p>This option should contain the path to an existing PEM-encoded ECDSA public key. The following command can generate a compatible public key for usage with Defcon's controller:</p>
<pre><code class="language-shell">$ openssl ecparam -genkey -name prime256v1 -noout | openssl pkcs8 -topk8 -nocrypt -out defcon-private.pem
$ openssl ec -in defcon-private.pem -pubout -out defcon-public.pem
</code></pre>
<h3><a class="header" href="#api_enable" id="api_enable"><code>API_ENABLE</code></a></h3>
<p>A value of <code>0</code> or <code>1</code> respectively disables and enables the API process bundled within Defcon.</p>
<h3><a class="header" href="#api_listen" id="api_listen"><code>API_LISTEN</code></a></h3>
<p>A string representing an IP address and port on which the API process will bind its process. By default, the API is only reachable by the local host on port 8000.</p>
<h3><a class="header" href="#handler_enable" id="handler_enable"><code>HANDLER_ENABLE</code></a></h3>
<p>A value of <code>0</code> here disables check handling on the controller. If it is disabled, no check will run on this node. This is particularly useful if all your checks are configured to run on off-site runners and you would prefer to use the controller only as Defcon's control plane.</p>
<h3><a class="header" href="#handler_interval" id="handler_interval"><code>HANDLER_INTERVAL</code></a></h3>
<p>If the handler process is enabled, this setting defines at which interval we should try to determine if checks need to be run. Accepts human-readable durations (such as <code>1s</code> or <code>5m</code>), defaults to <code>1s</code> and cannot be smaller than one second.</p>
<h3><a class="header" href="#handler_spread" id="handler_spread"><code>HANDLER_SPREAD</code></a></h3>
<p>Maximum amount of time for the controller to wait before executing a stale check. This can be useful to prevent all checks running at the exact same time. When a check needs executing, if <code>HANDLER_SPREAD</code> is set to <code>5s</code>, Defcon will wait for a random duration between <code>0s</code> and <code>5s</code> before executing the related handler.</p>
<h3><a class="header" href="#cleaner_enable" id="cleaner_enable"><code>CLEANER_ENABLE</code></a></h3>
<p>Use <code>1</code> here if you wish to enable the cleaner process. The cleaner process is used to delete old items (events, site outages and confirmed outages) from the database. Only resolved outages are elligible to be cleaned.</p>
<h3><a class="header" href="#cleaner_interval" id="cleaner_interval"><code>CLEANER_INTERVAL</code></a></h3>
<p>This option defines the interval at which Defcon will check for database items to be deleted from the database. This is a maintenance operation and does not need to run as often as the handler process.</p>
<h3><a class="header" href="#cleaner_threshold" id="cleaner_threshold"><code>CLEANER_THRESHOLD</code></a></h3>
<p>How old should an outage be to be elligible for deletion? Here, a value of <code>6 months</code> will delete all resolved outages, site outages and events that are at least six months old.</p>
<h1><a class="header" href="#off-site-runner" id="off-site-runner">Off-site runner</a></h1>
<p>By default, all checks are run on the controller node, and require only one site outage for an outage to be confirmed. Defcon allows to offload check handling to other nodes by the use of off-site runners.</p>
<p>A runner is a stripped-down instance of Defcon that only knows how to run handlers and report their status back to the controller. Its workflow is the following:</p>
<ul>
<li>Regularly check with the controller for stale checks that are configured to run on this particular runner</li>
<li>Call the handlers for each of those checks</li>
<li>Report their status back to the controller</li>
<li>Start over</li>
</ul>
<p>An off-site runner authenticates itself to the controller by possessing the private key matching the controller's public key.</p>
<p>Whereas the controller is identified by the static <code>@controller</code> tag, each runner must be configured to have a unique tag, such as <code>eu-1</code> or <code>home-runner</code>. Site identifiers should only contain lowercase alphanumeric characters and dashes (<code>^[a-z0-9-]+$</code>)</p>
<h2><a class="header" href="#download-the-binary" id="download-the-binary">Download the binary</a></h2>
<pre><code class="language-shell">$ curl https://github.com/apognu/defcon/releases/download/tip/defcon-runner-tip-x86_64 &gt; defcon
$ chmod +x defcon
</code></pre>
<h2><a class="header" href="#generate-keys" id="generate-keys">Generate keys</a></h2>
<p>You first need to generate an ECDSA key pair that will be used when you add your first off-site runner (not covered in this guide). Without this key pair, the API endpoint used by the runners will be disabled.</p>
<pre><code class="language-shell">$ openssl ecparam -genkey -name prime256v1 -noout | openssl pkcs8 -topk8 -nocrypt -out defcon-private.pem
$ openssl ec -in defcon-private.pem -pubout -out defcon-public.pem
</code></pre>
<h2><a class="header" href="#start-the-controller-with-runner-support" id="start-the-controller-with-runner-support">Start the controller with runner support</a></h2>
<pre><code class="language-shell">$ PUBLIC_KEY=./defcon-public.pem \
  RUST_LOG=defcon=debug \
  DSN=mysql://defcon:password@mysql.host/defcon?ssl-mode=DISABLED \
  ./defcon
INFO[2021-02-06T11:48:51.801+0000] starting api process port=&quot;8000&quot;
INFO[2021-02-06T11:48:51.801+0000] starting handler process interval=&quot;1s&quot;
</code></pre>
<h2><a class="header" href="#start-a-runner" id="start-a-runner">Start a runner</a></h2>
<pre><code class="language-shell">$ PRIVATE_KEY=./defcon-private.pem \
  CONTROLLER_URL=http://127.0.0.1:8000 \
  SITE=eu-1 \
  ./defcon-runner
INFO[2021-02-06T14:18:36.973+0000] starting runner process site=&quot;eu-1&quot; poll_interval=&quot;1s&quot;
</code></pre>
<p>This runner will start running any stale check configured to run on site <code>eu-1</code>.</p>
<h1><a class="header" href="#checks-1" id="checks-1">Checks</a></h1>
<p>A check is used to describe an external service to be monitored. Among other things, it allows to specify some metadata about the check, how and where the check should be run, the actual handler configuration to use and conditions for confirming outages.</p>
<h2><a class="header" href="#metadata" id="metadata">Metadata</a></h2>
<table><thead><tr><th>Attribute</th><th>Type</th><th>Example value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>name</code></td><td>string</td><td><code>&quot;acme-public-site&quot;</code></td><td>A human-friendly name used in logs and alerters</td></tr>
<tr><td><code>alerter</code></td><td>UUID</td><td><code>&quot;19b9eb20-3e3e-46d5-801f-a912e159913c&quot;</code></td><td>Alerter to be triggered when an outage is created</td></tr>
<tr><td><code>enabled</code></td><td>bool</td><td><code>true</code></td><td>When disabled, a check will not run</td></tr>
<tr><td><code>silent</code></td><td>bool</td><td><code>false</code></td><td>When silent, a check will not trigger its alerter</td></tr>
<tr><td><code>group</code></td><td>object</td><td><code>{ &quot;uuid&quot;: &quot;9b77035c-218e-4d32-bcd7-4a015f7ee147&quot; }</code></td><td>Put the check into a pre-existing group</td></tr>
</tbody></table>
<h2><a class="header" href="#run-and-error-condition" id="run-and-error-condition">Run and error condition</a></h2>
<table><thead><tr><th>Attribute</th><th>Type</th><th>Example value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>sites</code></td><td>[int]</td><td><code>[&quot;us-1&quot;, &quot;eu-1&quot;]</code></td><td>List of sites where this check should run</td></tr>
<tr><td><code>interval</code></td><td>string</td><td><code>&quot;10s&quot;</code></td><td>Interval of time between subsequent runs</td></tr>
<tr><td><code>site_threshold</code></td><td>int</td><td>2</td><td>Number of sites that have to fail to confirm an outage</td></tr>
<tr><td><code>failing_threshold</code></td><td>int</td><td>3</td><td>Number of successive fails required to mark a site as failing</td></tr>
<tr><td><code>passing_threshold</code></td><td>int</td><td>3</td><td>Number of successive passes required to mark a site as recovered</td></tr>
</tbody></table>
<blockquote>
<p><strong>Note:</strong> if a check is to run on the controller, as well as another site, the controller's identifier should be given explicitely, e.g. <code>&quot;sites&quot;: [&quot;@controller&quot;, &quot;eu-1&quot;]</code>.</p>
</blockquote>
<h2><a class="header" href="#handler-specification" id="handler-specification">Handler specification</a></h2>
<p>Each check needs one more attribute, <code>spec</code>, detailed in the next section, where the handler specification is configured.</p>
<h1><a class="header" href="#groups" id="groups">Groups</a></h1>
<p>A group is used to group checks together, and be able to filter which checks you list through the API.</p>
<h2><a class="header" href="#metadata-1" id="metadata-1">Metadata</a></h2>
<table><thead><tr><th>Attribute</th><th>Type</th><th>Example value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>name</code></td><td>string</td><td><code>Personal</code></td><td>A human-friendly name for the group</td></tr>
</tbody></table>
<h1><a class="header" href="#handlers" id="handlers">Handlers</a></h1>
<h1><a class="header" href="#ping" id="ping">Ping</a></h1>
<h1><a class="header" href="#tcp-connection" id="tcp-connection">TCP connection</a></h1>
<h1><a class="header" href="#udp-datagram" id="udp-datagram">UDP datagram</a></h1>
<h1><a class="header" href="#http-request" id="http-request">HTTP request</a></h1>
<h1><a class="header" href="#dns" id="dns">DNS</a></h1>
<h1><a class="header" href="#domain-expiration" id="domain-expiration">Domain expiration</a></h1>
<h1><a class="header" href="#tls-expiration" id="tls-expiration">TLS expiration</a></h1>
<h1><a class="header" href="#app-stores" id="app-stores">App stores</a></h1>
<h1><a class="header" href="#dead-man-switch" id="dead-man-switch">Dead Man Switch</a></h1>
<h1><a class="header" href="#alerters-1" id="alerters-1">Alerters</a></h1>
<h1><a class="header" href="#rest-api" id="rest-api">REST API</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
